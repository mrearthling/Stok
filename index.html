<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Stok ve SatÄ±ÅŸ Takip UygulamasÄ±</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div id="app">
    <div v-if="!isLoggedIn" class="login-container">
        <h2>GiriÅŸ Yap</h2>
        <form @submit.prevent="login">
            <input type="text" v-model="loginUsername" placeholder="KullanÄ±cÄ± AdÄ±" required>
            <input type="password" v-model="loginPassword" placeholder="Åifre" required>
            <button type="submit">GiriÅŸ Yap</button>
        </form>
    </div>

    <div v-if="isLoggedIn">
      <nav class="navbar">
        <div class="logo">StokTakipÃ‡iÃ§ek</div>
        <ul>
          <li :class="{active: page==='products'}" @click="page='products'">ÃœrÃ¼nler</li>
          <li :class="{active: page==='stockview'}" @click="page='stockview'">Genel Stok</li>
          <li :class="{active: page==='stock'}" @click="page='stock'">Stok Ä°ÅŸlemleri</li>
          <li :class="{active: page==='sales'}" @click="page='sales'">SatÄ±ÅŸ</li>
          <li :class="{active: page==='reports'}" @click="page='reports'">Raporlar</li>
          <li v-if="isAdmin()" :class="{active: page==='users'}" @click="page='users'; fetchData('users');">KullanÄ±cÄ±lar</li>
          <li @click="logout" class="logout-btn">Ã‡Ä±kÄ±ÅŸ Yap ({{ currentUser ? currentUser.username : '' }})</li>
        </ul>
        <button @click="toggleTheme" class="theme-btn">
          <span v-if="theme==='light'">ğŸŒ</span>
          <span v-else>ğŸŒ™</span>
        </button>
      </nav>
      <main>
        <!-- HoÅŸ geldin ve rehber -->
        <div v-if="showWelcome" class="welcome-box">
          <h2>HoÅŸ geldiniz!</h2>
          <p>Bu uygulama ile Ã§iÃ§ek iÃ§erik bazlÄ± stok ve satÄ±ÅŸ takibi yapabilirsiniz. ÃœrÃ¼n ekleyin, stok giriÅŸ/Ã§Ä±kÄ±ÅŸ iÅŸlemleri yapÄ±n, satÄ±ÅŸlarÄ±nÄ±zÄ± kaydedin ve raporlarÄ± gÃ¶rÃ¼ntÃ¼leyin.</p>
          <button @click="showWelcome=false">Kapat</button>
        </div>
        <!-- ÃœrÃ¼n YÃ¶netimi -->
        <section v-if="page==='products'">
          <div class="section-header">
            <h2>Ä°Ã§erik ÃœrÃ¼nleri</h2>
            <button @click="showProductForm('content')">+ Ä°Ã§erik ÃœrÃ¼nÃ¼ Ekle</button>
          </div>
          <table class="table-pro">
            <thead>
              <tr>
                <th>AdÄ±</th>
                <th>Kodu</th>
                <th>Birim</th>
                <th>Stok</th>
                <th>Kritik</th>
                <th>GÃ¶rsel</th>
                <th>Ä°ÅŸlemler</th>
              </tr>
            </thead>
            <tbody>
              <tr v-for="content in contents" :key="content.id">
                <td>{{content.name}}</td>
                <td>{{content.code}}</td>
                <td>{{content.unit}}</td>
                <td>{{content.stock}}</td>
                <td>{{content.critical}}</td>
                <td>
                  <img v-if="content.imageUrl" :src="content.imageUrl" alt="ÃœrÃ¼n GÃ¶rseli" class="product-image" @click="showLargeImage(content.imageUrl)">
                </td>
                <td>
                  <button @click="editProduct(content)" title="DÃ¼zenle">âœï¸</button>
                  <button @click="deleteProduct(content.id)" title="Sil">ğŸ—‘ï¸</button>
                </td>
              </tr>
            </tbody>
          </table>
          <div class="section-header" style="margin-top:2em;">
            <h2>Buketler / ÃœrÃ¼nler</h2>
            <button @click="showProductForm('product')">+ Buket/ÃœrÃ¼n Ekle</button>
          </div>
          <table class="table-pro">
            <thead>
              <tr>
                <th>AdÄ±</th>
                <th>Kodu</th>
                <th>Ä°Ã§erik</th>
                <th>GÃ¶rsel</th>
                <th>Ä°ÅŸlemler</th>
              </tr>
            </thead>
            <tbody>
              <tr v-for="product in bouquets" :key="product.id">
                <td>{{product.name}}</td>
                <td>{{product.code}}</td>
                <td>
                  <div v-for="c in product.contents" :key="c.contentId">
                    {{getContentName(c.contentId)}} ({{c.amount}} {{getContentUnit(c.contentId)}})
                  </div>
                </td>
                <td>
                  <img v-if="product.imageUrl" :src="product.imageUrl" alt="ÃœrÃ¼n GÃ¶rseli" class="product-image" @click="showLargeImage(product.imageUrl)">
                </td>
                <td>
                  <button @click="editProduct(product)" title="DÃ¼zenle">âœï¸</button>
                  <button @click="copyProduct(product)" title="Kopyala">ğŸ“‹</button>
                  <button @click="deleteProduct(product.id)" title="Sil">ğŸ—‘ï¸</button>
                </td>
              </tr>
            </tbody>
          </table>
        </section>
        <!-- Genel Stok GÃ¶rÃ¼ntÃ¼leme -->
        <section v-if="page==='stockview'">
          <div class="section-header">
            <h2>Genel Stok</h2>
            <input v-model="stockSearch" placeholder="Ã‡iÃ§ek tÃ¼rÃ¼ ara..." class="search-box">
          </div>
          <table class="table-pro">
            <thead>
              <tr>
                <th>Ã‡iÃ§ek TÃ¼rÃ¼</th>
                <th>Stok</th>
                <th>Birim</th>
                <th>UyarÄ±</th>
                <th>GeÃ§miÅŸ</th>
              </tr>
            </thead>
            <tbody>
              <tr v-for="content in filteredContents" :key="content.id">
                <td>{{content.name}}</td>
                <td :class="{'low-stock': content.stock <= content.critical}">{{content.stock}}</td>
                <td>{{content.unit}}</td>
                <td>
                  <span v-if="content.stock <= content.critical" title="Kritik stok!" class="warn-icon">âš ï¸</span>
                </td>
                <td>
                  <button @click="showContentHistory(content)">ğŸ“ˆ</button>
                </td>
              </tr>
            </tbody>
          </table>
          <!-- Ä°Ã§erik geÃ§miÅŸi modalÄ± -->
          <div v-if="showHistoryModal" class="modal">
            <div class="modal-content">
              <h3>{{historyContentName}} - Stok GeÃ§miÅŸi</h3>
              <table>
                <thead>
                  <tr>
                    <th>Tarih</th>
                    <th>Tip</th>
                    <th>Miktar</th>
                    <th>AÃ§Ä±klama</th>
                  </tr>
                </thead>
                <tbody>
                  <tr v-for="move in historyMoves" :key="move.id">
                    <td>{{formatDate(move.date)}}</td>
                    <td>{{move.type}}</td>
                    <td>{{move.amount}}</td>
                    <td>{{move.note}}</td>
                  </tr>
                </tbody>
              </table>
              <div class="modal-actions">
                <button @click="showHistoryModal=false">Kapat</button>
              </div>
            </div>
          </div>
        </section>
        <!-- Stok Ä°ÅŸlemleri -->
        <section v-if="page==='stock'">
          <div class="section-header">
            <h2>Stok Ä°ÅŸlemleri (Sadece Ä°Ã§erik ÃœrÃ¼nleri)</h2>
            <button @click="showStockModal=true">+ Stok Hareketi Ekle</button>
          </div>
          <table class="table-pro">
            <thead>
              <tr>
                <th>Tarih</th>
                <th>Ã‡iÃ§ek TÃ¼rÃ¼</th>
                <th>Miktar</th>
                <th>Birim</th>
                <th>Tip</th>
                <th>AÃ§Ä±klama</th>
              </tr>
            </thead>
            <tbody>
              <tr v-for="move in stockMovesSorted" :key="move.id">
                <td>{{formatDate(move.date)}}</td>
                <td>{{getContentName(move.contentId)}}</td>
                <td>{{move.amount}}</td>
                <td>{{getContentUnit(move.contentId)}}</td>
                <td>{{move.type}}</td>
                <td>{{move.note}}</td>
              </tr>
            </tbody>
          </table>
        </section>
        <!-- SatÄ±ÅŸ ModÃ¼lÃ¼ -->
        <section v-if="page==='sales'">
          <div class="section-header">
            <h2>SatÄ±ÅŸ ModÃ¼lÃ¼</h2>
            <button @click="showSaleModal=true">+ SatÄ±ÅŸ Yap</button>
          </div>
          <table class="table-pro">
            <thead>
              <tr>
                <th>Tarih</th>
                <th>Tip</th>
                <th>AdÄ±</th>
                <th>Kodu</th>
                <th>Miktar</th>
                <th>Tutar</th>
              </tr>
            </thead>
            <tbody>
              <tr v-for="sale in salesSorted" :key="sale.id">
                <td>{{formatDate(sale.date)}}</td>
                <td>{{sale.itemType === 'content' ? 'Ä°Ã§erik ÃœrÃ¼nÃ¼' : 'Buket/ÃœrÃ¼n'}}</td>
                <td v-if="sale.itemType === 'content'">{{getContentName(sale.itemId)}}</td>
                <td v-else>{{getProductName(sale.itemId)}}</td>
                <td v-if="sale.itemType === 'content'">{{getProductCode(sale.itemId)}}</td>
                <td v-else>{{getProductCode(sale.itemId)}}</td>
                <td>{{sale.amount}}</td>
                <td>{{sale.total | currency}}</td>
              </tr>
            </tbody>
          </table>
        </section>
        <!-- Raporlama -->
        <section v-if="page==='reports'">
          <div class="section-header">
            <h2>Raporlama</h2>
            <button @click="exportData('json')">JSON Export</button>
            <button @click="exportData('csv')">CSV Export</button>
            <button @click="resetAllData" style="background:var(--danger);margin-left:1em;">Verileri SÄ±fÄ±rla</button>
            <label for="import-json" class="button">JSON Import</label>
            <input type="file" id="import-json" accept=".json" @change="importData" style="display: none;">
          </div>
          <div v-if="saleSuccess" class="success-box">SatÄ±ÅŸ sonrasÄ± stoklar gÃ¼ncellendi.</div>
          <div v-if="importSuccess" class="success-box">Veriler baÅŸarÄ±yla iÃ§e aktarÄ±ldÄ±. Uygulama yenileniyor...</div>
          <div class="report-block">
            <h3>Ã‡iÃ§ek TÃ¼rÃ¼ BazlÄ± Stok Listesi</h3>
            <table class="table-pro">
              <thead>
                <tr>
                  <th>Ã‡iÃ§ek TÃ¼rÃ¼</th>
                  <th>Stok</th>
                  <th>Birim</th>
                </tr>
              </thead>
              <tbody>
                <tr v-for="content in contents" :key="content.id">
                  <td>{{content.name}}</td>
                  <td>{{content.stock}}</td>
                  <td>{{content.unit}}</td>
                </tr>
              </tbody>
            </table>
          </div>
          <div class="report-block">
            <h3>Ã‡iÃ§ek TÃ¼rÃ¼ne GÃ¶re SatÄ±ÅŸ ToplamlarÄ±</h3>
            <canvas id="contentSalesChart" height="120"></canvas>
          </div>
          <div class="report-block">
            <h3>GÃ¼nlÃ¼k/AylÄ±k SatÄ±ÅŸ Raporu</h3>
            <canvas id="dailySalesChart" height="120"></canvas>
          </div>
        </section>

        <!-- KullanÄ±cÄ± YÃ¶netimi -->
        <section v-if="page==='users' && isAdmin()">
            <div class="section-header">
                <h2>KullanÄ±cÄ± YÃ¶netimi</h2>
                <button @click="addUser">Yeni KullanÄ±cÄ± Ekle</button>
            </div>
            <table class="table-pro">
                <thead>
                    <tr>
                        <th>KullanÄ±cÄ± AdÄ±</th>
                        <th>Rol</th>
                        <th>Ä°ÅŸlemler</th>
                    </tr>
                </thead>
                <tbody>
                    <tr v-for="user in users" :key="user.id">
                        <td>{{ user.username }}</td>
                        <td>{{ user.role }}</td>
                        <td>
                            <button @click="deleteUser(user.id)" :disabled="user.username === 'Avrasya'" title="Sil">ğŸ—‘ï¸</button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </section>

        <!-- ÃœrÃ¼n ModalÄ± -->
        <div v-if="showProductModal" class="modal">
          <div class="modal-content">
            <h3>{{productForm.type === 'content' ? 'Ä°Ã§erik ÃœrÃ¼nÃ¼' : 'Buket/ÃœrÃ¼n'}} {{editMode ? 'DÃ¼zenle' : 'Ekle'}}</h3>
            <form @submit.prevent="saveProduct">
              <div class="form-row">
                <label>Tip:</label>
                <select v-model="productForm.type">
                  <option value="content">Ä°Ã§erik ÃœrÃ¼nÃ¼</option>
                  <option value="product">Buket/ÃœrÃ¼n</option>
                </select>
              </div>
              <div class="form-row">
                <input v-model="productForm.name" placeholder="AdÄ±" required>
                <input v-model="productForm.code" placeholder="Kodu" required>
              </div>
              <div class="form-row">
                <input v-model="productForm.imageUrl" placeholder="GÃ¶rsel URL (isteÄŸe baÄŸlÄ±)">
              </div>
              <div v-if="productForm.type === 'content'">
                <div class="form-row">
                  <input v-model="productForm.unit" placeholder="Birim (adet/dal)" required>
                  <input v-model.number="productForm.stock" type="number" min="0" placeholder="Stok" required>
                  <input v-model.number="productForm.critical" type="number" min="0" placeholder="Kritik Stok" required>
                </div>
              </div>
              <div v-else>
                <h4>Ä°Ã§erik (Ã‡iÃ§ekler)</h4>
                <div v-for="(c, i) in productForm.contents" :key="i" class="variant-row">
                  <select v-model="c.contentId" required>
                    <option value="" disabled>Ã‡iÃ§ek TÃ¼rÃ¼ SeÃ§</option>
                    <option v-for="content in contents" :value="content.id">{{content.name}} ({{content.unit}})</option>
                  </select>
                  <input v-model.number="c.amount" type="number" min="1" placeholder="Miktar" required>
                  <button type="button" @click="removeContentFromProduct(i)">-</button>
                </div>
                <button type="button" @click="addContentToProduct">+ Ä°Ã§erik Ekle</button>
              </div>
              <div class="modal-actions">
                <button type="submit">Kaydet</button>
                <button type="button" @click="closeProductModal">Ä°ptal</button>
              </div>
            </form>
          </div>
        </div>
        <!-- Stok ModalÄ± -->
        <div v-if="showStockModal" class="modal">
          <div class="modal-content">
            <h3>Stok Hareketi Ekle</h3>
            <form @submit.prevent="saveStockMove">
              <select v-model="stockForm.contentId" required>
                <option value="" disabled>Ã‡iÃ§ek TÃ¼rÃ¼ SeÃ§</option>
                <option v-for="c in contents" :value="c.id">{{c.name}}</option>
              </select>
              <select v-model="stockForm.type" required>
                <option value="giriÅŸ">Stok GiriÅŸ</option>
                <option value="Ã§Ä±kÄ±ÅŸ">Stok Ã‡Ä±kÄ±ÅŸ</option>
                <option value="sayÄ±m">SayÄ±m</option>
              </select>
              <input v-model.number="stockForm.amount" type="number" min="1" placeholder="Miktar" required>
              <input v-model="stockForm.note" placeholder="AÃ§Ä±klama">
              <div class="modal-actions">
                <button type="submit">Kaydet</button>
                <button type="button" @click="showStockModal=false">Ä°ptal</button>
              </div>
            </form>
          </div>
        </div>
        <!-- SatÄ±ÅŸ ModalÄ± -->
        <div v-if="showSaleModal" class="modal">
          <div class="modal-content">
            <h3>SatÄ±ÅŸ Yap</h3>
            <form @submit.prevent="saveSale">
              <div class="form-row">
                <label>Tip:</label>
                <select v-model="saleForm.itemType">
                  <option value="content">Ä°Ã§erik ÃœrÃ¼nÃ¼</option>
                  <option value="product">Buket/ÃœrÃ¼n</option>
                </select>
              </div>
              <div class="form-row">
                <select v-model="saleForm.itemId" required>
                  <option value="" disabled>SeÃ§iniz</option>
                  <option v-if="saleForm.itemType==='content'" v-for="c in contents" :value="c.id">{{c.name}}</option>
                  <option v-if="saleForm.itemType==='product'" v-for="p in bouquets" :value="p.id">{{p.name}}</option>
                </select>
                <input v-model.number="saleForm.amount" type="number" min="1" placeholder="Miktar" required>
                <input v-model.number="saleForm.price" type="number" min="0" placeholder="Toplam Fiyat" required>
              </div>
              <div class="modal-actions">
                <button type="submit">SatÄ±ÅŸÄ± Kaydet</button>
                <button type="button" @click="showSaleModal=false">Ä°ptal</button>
              </div>
            </form>
          </div>
        </div>
        <!-- Resim BÃ¼yÃ¼tme ModalÄ± -->
        <div v-if="showImageModal" class="modal image-modal" @click="showImageModal = false">
          <img :src="currentImageUrl" alt="BÃ¼yÃ¼k GÃ¶rsel">
        </div>
      </main>
    </div>
  </div>
  <script src="app.js"></script>
</body>
</html>